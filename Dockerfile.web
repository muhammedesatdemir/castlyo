# ---------- builder ----------
FROM node:20-alpine AS builder
WORKDIR /app

# Sadece paket manifestlerini kopyala
COPY package*.json ./
COPY apps/web/package*.json ./apps/web/
COPY packages/ui/package*.json ./packages/ui/
COPY packages/types/package*.json ./packages/types/
COPY packages/database/package*.json ./packages/database/

# Workspace bağımlılıklarını container içinde kur
RUN npm ci

# Şimdi tüm kaynak kodu kopyala
COPY . .

# Web'i build et (Next.js)
RUN npm run build --workspace=@castlyo/web

# ---------- runner ----------
FROM node:20-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# Next.js standalone çıktı kullan
COPY --from=builder /app/apps/web/.next /app/apps/web/.next
COPY --from=builder /app/apps/web/public /app/apps/web/public
COPY --from=builder /app/apps/web/package*.json /app/apps/web/
COPY --from=builder /app/node_modules /app/node_modules

# Next.js config dosyalarını kopyala
COPY --from=builder /app/apps/web/next.config.js /app/apps/web/
COPY --from=builder /app/apps/web/tailwind.config.js /app/apps/web/
COPY --from=builder /app/apps/web/postcss.config.js /app/apps/web/

EXPOSE 3000

# Next.js start script'i
CMD ["npm","run","start","--workspace=@castlyo/web"]
